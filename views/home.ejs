<!DOCTYPE html>
<html>

<head>
    <title>Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

    <div class="container">

        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#invoiceModal">
            Open Invoice
        </button>

        <% if (!invoices || invoices.length===0) { %>
            <p><b>No invoices found.</b></p>
            <% } else { %>

                <table class="table table-bordered">
                    <tr>
                        <th>Name</th>
                        <th>Address</th>
                        <th>MobileNo</th>
                        <th>Total</th>
                        <th>Invoice total</th>
                        <th>Action</th>
                        <th>Edit</th>
                    </tr>

                    <% for (var i=0; i < invoices.length; i++) { %>
                        <tr>
                            <td>
                                <%= invoices[i].Name %>
                            </td>
                            <td>
                                <%= invoices[i].Address %>
                            </td>
                            <td>
                                <%= invoices[i].MobileNo %>
                            </td>
                            <td>
                                <%= invoices[i].totalAmount %>
                            </td>
                            <td>
                                <%= invoices[i].invoiceTotalAfter %>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="openItems('<%= invoices[i]._id %>')">
                                    View Items
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="editInvoice('<%= invoices[i]._id %>')">
                                    Edit
                                </button>
                            </td>
                        </tr>
                        <% } %>
                </table>
                <% } %>

    </div>

    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <form action="/api/invoice/create" method="POST">

                        <head>

                            <link rel="stylesheet" href="/index.css">

                            <title>Tax Invoice</title>

                        </head>
                        <div class="container text-center">
                            <div class="card">
                                <div class="card-header-top">
                                    <h6>Default Company Profile</h6>
                                    <h3>Demo Company</h3>
                                    <h6>GSTIN: ssdcd</h6>
                                </div>
                                <div class="card-header-bottom">
                                    <div class="row">
                                        <div class="col">
                                            +91-1234567890
                                        </div>
                                        <div class="col">
                                            demo address
                                        </div>
                                        <div class="col">
                                            +91-9876543210
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="card-body-1">
                                    <h6># TAX INVOICE #</h6>
                                </div>
                                <hr>
                                <form id="invoiceForm" action="/api/invoice/create" method="POST">


                                    <div class="card-body-2">

                                        <table class="table table-bordered align-middle">

                                            <tr>
                                                <th colspan="5" class="text-start">Receiver's Details</th>
                                                <th colspan="5" class="text-start">Invoice Details</th>
                                            </tr>

                                            <tr>
                                                <td colspan="5">
                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Name</span>
                                                        <input type="text" name="Name" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Address</span>
                                                        <input type="text" name="Address" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">MobileNo</span>
                                                        <input type="text" name="MobileNo" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">State</span>
                                                        <input type="text" name="State" class="form-control">
                                                    </div>

                                                    <div class="input-group">
                                                        <span class="input-group-text">GSTIN</span>
                                                        <input type="text" name="GSTIN" class="form-control">
                                                    </div>
                                                </td>

                                                <td colspan="5">
                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Invoice No</span>
                                                        <input type="text" name="InvoiceNo" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Chalan No.</span>
                                                        <input type="text" name="ChalanNo" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Invoice Date</span>
                                                        <input type="text" name="InvoiceDate" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Due Date</span>
                                                        <input type="text" name="DueDate" class="form-control">
                                                    </div>

                                                    <div class="mb-2 input-group">
                                                        <span class="input-group-text">Payment Terms</span>
                                                        <input type="text" name="PaymentTerms" class="form-control">
                                                    </div>

                                                    <div class="input-group">
                                                        <span class="input-group-text">Eway Bill</span>
                                                        <input type="text" name="EwayBill" class="form-control">
                                                    </div>
                                                </td>
                                            </tr>


                                            <tr class="text-center">
                                                <th>Sr</th>
                                                <th>Desc.</th>
                                                <th>Design No.</th>
                                                <th>HSN</th>
                                                <th>Qty</th>
                                                <th>Cut</th>
                                                <th>MTR</th>
                                                <th>Qty Unit</th>
                                                <th>Rate</th>
                                                <th>
                                                    Amount
                                                    <button type="button" class="btn btn-sm btn-primary mt-1"
                                                        onclick="addRow()">+</button>
                                                </th>
                                            </tr>

                                            <tbody id="invoiceBody">
                                                <tr>
                                                    <td>1</td>

                                                    <td><input type="text" name="items[0][Desc]" class="form-control">
                                                    </td>

                                                    <td><input type="text" name="items[0][DesignNo]"
                                                            class="form-control"></td>

                                                    <td><input type="text" name="items[0][HSN]" class="form-control">
                                                    </td>

                                                    <td><input type="number" name="items[0][Qty]"
                                                            class="form-control qty" value="0"
                                                            oninput="calculateRow(this)"></td>

                                                    <td><input type="number" name="items[0][Cut]"
                                                            class="form-control cut" value="0"
                                                            oninput="calculateRow(this)"></td>

                                                    <td><input type="number" name="items[0][MTR]"
                                                            class="form-control mtr" value="0"
                                                            oninput="calculateRow(this)"></td>

                                                    <td>
                                                        <select name="items[0][Unit]" class="form-select unit"
                                                            onchange="calculateRow(this)">
                                                            <option value="PCS">PCS</option>
                                                            <option value="MTR">MTR</option>
                                                            <option value="CUT">CUT</option>
                                                        </select>
                                                    </td>

                                                    <td><input type="number" name="items[0][Rate]"
                                                            class="form-control rate" value="0"
                                                            oninput="calculateRow(this)"></td>

                                                    <td><input type="number" name="items[0][Amount]"
                                                            class="form-control amount" value="0" readonly></td>
                                                </tr>

                                            </tbody>

                                            <tr>
                                                <td colspan="9" class="text-start"><strong>Total</strong></td>
                                                <td><input type="number" id="totalAmount" name="totalAmount"
                                                        class="form-control" value="0" readonly></td>
                                            </tr>

                                            <tr>
                                                <td colspan="7" class="text-center">Amount (in words)</td>
                                                <td colspan="2" class="text-start">Dis (00 %)</td>
                                                <td colspan="1">
                                                    <input type="number" id="discount" name="discount"
                                                        oninput="calculateTotal()" class="form-control">
                                                </td>
                                            </tr>


                                            <tr>
                                                <td colspan="7"><span id="amountWords" name="amountWords">Zero
                                                        Rupees Only</span></td>
                                                <td colspan="2" class="text-start"><strong>Taxable Value</strong>
                                                </td>
                                                <td colspan="1">
                                                    <input type="number" id="taxableValue" name="taxableValue"
                                                        class="form-control" readonly>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="7" rowspan="6" class="align-top text-start">
                                                    PAN: sdsdc<br>
                                                    Bank Name: zc<br>
                                                    Account No: zxc<br>
                                                    Branch Name: zsc<br>
                                                    IFSC: 64
                                                </td>

                                                <td colspan="2" class="text-start">CGST (00 %)</td>
                                                <td colspan="1">
                                                    <input type="number" id="CGST" name="CGST"
                                                        oninput="handleGST('CGST')" class="form-control">
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2" class="text-start">SGST (00 %)</td>
                                                <td colspan="1">
                                                    <input type="number" id="SGST" name="SGST"
                                                        oninput="handleGST('SGST')" class="form-control">
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2" class="text-start">IGST (5 %)</td>
                                                <td colspan="1">
                                                    <input type="number" id="IGST" name="IGST"
                                                        oninput="handleGST('IGST')" class="form-control">
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2" class="text-start">Invoice Total</td>
                                                <td colspan="1">
                                                    <input type="number" id="invoiceTotalbefore"
                                                        name="invoiceTotalbefore" class="form-control" readonly>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2" class="text-start">Round Off(+/-)</td>
                                                <td colspan="1" class="text-start">
                                                    <input type="number" id="roundoff" name="roundoff"
                                                        class="form-control" readonly>
                                                </td>
                                            </tr>

                                            <tr>
                                                <td colspan="2" class="text-start"><strong>Invoice Total</strong>
                                                </td>
                                                <td colspan="1">
                                                    <input type="number" id="invoiceTotalafter" name="invoiceTotalAfter"
                                                        class="form-control" readonly>
                                                </td>
                                            </tr>



                                            <tr style="height:120px;">
                                                <td colspan="7" class="text-start">
                                                    TERM & CONDITION<br>
                                                    SUBJECT TO SURAT JURISDICTION E.&O.E.<br>
                                                    Goods once sold will not be taken back or replaced.<br>
                                                    Any complaint of goods should be made within 7 days.<br>
                                                    Interest @ 4% per month will be charged on the bill.<br>
                                                    Receiver's Sign. ___________________
                                                </td>
                                                <td colspan="3" class="text-center">
                                                    For, Demo Company<br><br><br>
                                                    Authorised Sign<br>
                                                    ___________________
                                                </td>
                                            </tr>

                                        </table>


                                        <button type="submit" class="btn btn-success px-5">Submit</button>

                                    </div>
                                </form>

                            </div>
                        </div>

                        <script>

                            function calculateRow(element) {

                                var row = element.closest("tr");

                                var qty = Number(row.querySelector(".qty").value) || 0;
                                var cut = Number(row.querySelector(".cut").value) || 0;
                                var mtr = Number(row.querySelector(".mtr").value) || 0;
                                var rate = Number(row.querySelector(".rate").value) || 0;
                                var unit = row.querySelector(".unit").value;

                                var amountInput = row.querySelector(".amount");

                                var amount = 0;

                                switch (unit) {

                                    case "PCS":
                                        amount = qty * rate;
                                        break;

                                    case "MTR":
                                        amount = mtr * rate;
                                        break;

                                    case "CUT":
                                        amount = cut * rate;
                                        break;

                                    default:
                                        amount = 0;
                                }

                                amountInput.value = amount;

                                calculateTotal();
                            }


                            function calculateTotal() {
                                var total = 0;

                                var amounts = document.querySelectorAll(".amount");

                                amounts.forEach(function (input) {
                                    total = total + (Number(input.value) || 0);
                                });

                                document.getElementById("totalAmount").value = total;

                                var discountPercent = Number(document.getElementById("discount").value) || 0;

                                var discountValue = (total * discountPercent) / 100;

                                var taxable = total - discountValue;

                                document.getElementById("taxableValue").value = taxable;

                                var cgstPercent = Number(document.getElementById("CGST").value) || 0;
                                var sgstPercent = Number(document.getElementById("SGST").value) || 0;
                                var igstPercent = Number(document.getElementById("IGST").value) || 0;

                                var cgstValue = (taxable * cgstPercent) / 100;
                                var sgstValue = (taxable * sgstPercent) / 100;
                                var igstValue = (taxable * igstPercent) / 100;

                                var finalTotal = taxable + cgstValue + sgstValue + igstValue;

                                document.getElementById("invoiceTotalbefore").value = finalTotal.toFixed(2);

                                var rounded = Math.round(finalTotal);

                                var difference = rounded - finalTotal;

                                difference = difference.toFixed(2);

                                document.getElementById("roundoff").value = difference;

                                document.getElementById("invoiceTotalafter").value = rounded;

                                document.getElementById("amountWords").innerText =
                                    numberToWords(rounded) + " Rupees Only";
                            }



                            function handleGST(type) {

                                if (type === "IGST") {

                                    document.getElementById("CGST").value = 0;
                                    document.getElementById("SGST").value = 0;

                                } else {

                                    document.getElementById("IGST").value = 0;
                                }

                                calculateTotal();
                            }


                            function numberToWords(num) {

                                var ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
                                var teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen",
                                    "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
                                var tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty",
                                    "Sixty", "Seventy", "Eighty", "Ninety"];

                                if (num === 0) return "Zero";

                                function twoDigit(n) {
                                    if (n < 10) return ones[n];
                                    if (n < 20) return teens[n - 10];
                                    return tens[Math.floor(n / 10)] + " " + ones[n % 10];
                                }

                                function threeDigit(n) {
                                    if (n < 100) return twoDigit(n);
                                    return ones[Math.floor(n / 100)] + " Hundred " + twoDigit(n % 100);
                                }

                                var word = "";

                                if (num >= 100000) {
                                    word += threeDigit(Math.floor(num / 100000)) + " Lakh ";
                                    num = num % 100000;
                                }

                                if (num >= 1000) {
                                    word += threeDigit(Math.floor(num / 1000)) + " Thousand ";
                                    num = num % 1000;
                                }

                                if (num > 0) {
                                    word += threeDigit(num);
                                }

                                return word.trim();
                            }


                            function addRow() {

                                const tbody = document.getElementById("invoiceBody");


                                const rowCount = tbody.rows.length;

                                const tr = document.createElement("tr");

                                tr.innerHTML = `
        <td>${rowCount + 1}</td>

        <td><input type="text" name="items[${rowCount}][Desc]" class="form-control"></td>

        <td><input type="text" name="items[${rowCount}][DesignNo]" class="form-control"></td>

        <td><input type="text" name="items[${rowCount}][HSN]" class="form-control"></td>

        <td>
            <input type="number" name="items[${rowCount}][Qty]" 
                class="form-control qty" value="0"
                oninput="calculateRow(this)">
        </td>

        <td>
            <input type="number" name="items[${rowCount}][Cut]" 
                class="form-control cut" value="0"
                oninput="calculateRow(this)">
        </td>

        <td>
            <input type="number" name="items[${rowCount}][MTR]" 
                class="form-control mtr" value="0">
        </td>

        <td>
            <select name="items[${rowCount}][Unit]" 
                class="form-select unit"
                onchange="calculateRow(this)">
                <option value="PCS">PCS</option>
                <option value="MTR">MTR</option>
                <option value="CUT">CUT</option>
            </select>
        </td>

        <td>
            <input type="number" name="items[${rowCount}][Rate]" 
                class="form-control rate" value="0"
                oninput="calculateRow(this)">
        </td>

        <td>
            <input type="number" name="items[${rowCount}][Amount]" 
                class="form-control amount" value="0"
                readonly>
        </td>
    `;

                                tbody.appendChild(tr);
                            }


                        </script>
                    </form>

                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="itemsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered" id="itemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Design No.</th>
                                <th>Qty</th>
                                <th>Cut</th>
                                <th>MTR</th>
                                <th>Unit</th>
                                <th>Rate</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <tr>
                                <td colspan="8" class="text-center"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function editInvoice(invoiceId) {
            if (!invoiceId) {
          
                alert('Invoice ID not found');
                return;
            }
            fetch('/api/invoice/' + invoiceId)
                .then(response => {
                   
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(invoice => {

                    let nameInput = document.querySelector('input[name="Name"]');
                    if (!nameInput) {
                        console.error('6. Name input field not found!');
                        alert('Form elements not found!');
                        return;
                    }

                    nameInput.value = invoice.Name || '';
                    document.querySelector('input[name="Address"]').value = invoice.Address || '';
                    document.querySelector('input[name="MobileNo"]').value = invoice.MobileNo || '';
                    document.querySelector('input[name="State"]').value = invoice.State || '';
                    document.querySelector('input[name="GSTIN"]').value = invoice.GSTIN || '';

                    document.querySelector('input[name="InvoiceNo"]').value = invoice.InvoiceNo || '';
                    document.querySelector('input[name="ChalanNo"]').value = invoice.ChalanNo || '';
                    document.querySelector('input[name="InvoiceDate"]').value = invoice.InvoiceDate || '';
                    document.querySelector('input[name="DueDate"]').value = invoice.DueDate || '';
                    document.querySelector('input[name="PaymentTerms"]').value = invoice.PaymentTerms || '';
                    document.querySelector('input[name="EwayBill"]').value = invoice.EwayBill || '';

                    let tbody = document.getElementById('invoiceBody');
                    if (tbody) {
                        tbody.innerHTML = '';

                        if (invoice.items && invoice.items.length > 0) {
                            invoice.items.forEach((item, index) => {
                                addRowWithData(item, index);
                            });
                        } else {
                            addRow();
                        }
                    }

                    document.getElementById('discount').value = invoice.discount || 0;
                    document.getElementById('CGST').value = invoice.CGST || 0;
                    document.getElementById('SGST').value = invoice.SGST || 0;
                    document.getElementById('IGST').value = invoice.IGST || 0;

                    if (typeof calculateTotal === 'function') {
                        calculateTotal();
                    }

                    let form = document.getElementById('invoiceForm');
                    if (form) {
                        form.action = '/api/invoice/update/' + invoiceId;
                    }

                    let modalTitle = document.querySelector('#invoiceModal .modal-title');
                    if (modalTitle) {
                        modalTitle.textContent = 'Edit Invoice';
                    }
                    console.log('7. Showing modal');
                    var modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('8. Error:', error);
                    alert('Error loading invoice: ' + error.message);
                });
        }
        function addRowWithData(item, index) {
            const tbody = document.getElementById('invoiceBody');
            const tr = document.createElement('tr');

            tr.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="text" name="items[${index}][Desc]" class="form-control" value="${item.Desc ? item.Desc.replace(/"/g, '&quot;') : ''}"></td>
            <td><input type="text" name="items[${index}][DesignNo]" class="form-control" value="${item.DesignNo || ''}"></td>
            <td><input type="text" name="items[${index}][HSN]" class="form-control" value="${item.HSN || ''}"></td>
            <td><input type="number" name="items[${index}][Qty]" class="form-control qty" value="${item.Qty || 0}" oninput="calculateRow(this)"></td>
            <td><input type="number" name="items[${index}][Cut]" class="form-control cut" value="${item.Cut || 0}" oninput="calculateRow(this)"></td>
            <td><input type="number" name="items[${index}][MTR]" class="form-control mtr" value="${item.MTR || 0}" oninput="calculateRow(this)"></td>
            <td>
                <select name="items[${index}][Unit]" class="form-select unit" onchange="calculateRow(this)">
                    <option value="PCS" ${item.Unit === 'PCS' ? 'selected' : ''}>PCS</option>
                    <option value="MTR" ${item.Unit === 'MTR' ? 'selected' : ''}>MTR</option>
                    <option value="CUT" ${item.Unit === 'CUT' ? 'selected' : ''}>CUT</option>
                </select>
            </td>
            <td><input type="number" name="items[${index}][Rate]" class="form-control rate" value="${item.Rate || 0}" oninput="calculateRow(this)"></td>
            <td><input type="number" name="items[${index}][Amount]" class="form-control amount" value="${item.Amount || 0}" readonly></td>
        `;

            tbody.appendChild(tr);
        }

        function openItems(invoiceId) {

            fetch('/api/invoice/' + invoiceId)
                .then(response => response.json())
                .then(invoice => {
                    let tbody = document.getElementById('itemsTableBody');
                    tbody.innerHTML = '';

                    if (!invoice.items || invoice.items.length === 0) {
                        let row = tbody.insertRow();
                        let cell = row.insertCell();
                        cell.colSpan = 8;
                        cell.className = 'text-center';
                        cell.textContent = 'No items';
                    } else {
                        invoice.items.forEach(item => {
                            let row = tbody.insertRow();

                            let cells = [
                                item.Desc || '-',
                                item.DesignNo || '-',
                                item.Qty || '0',
                                item.Cut || '0',
                                item.MTR || '0',
                                item.Unit || '-',
                                item.Rate || '0',
                                item.Amount || '0'
                            ];

                            cells.forEach(text => {
                                let cell = row.insertCell();
                                cell.textContent = text;
                            });
                        });
                    }

                    var modal = new bootstrap.Modal(document.getElementById('itemsModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('itemsTableBody').innerHTML =
                        '<tr><td colspan="8" class="text-center text-danger">Error loading items</td></tr>';
                });
        }
    </script>
</body>

</html>